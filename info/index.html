<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<title>Community Info</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/x-icon" href="../img/logo/neighborhood-icon.png" />

<script type="text/javascript" src="../js/jquery/jquery-1.12.4.min.js" id="http://localhost:8887/localsite/js/jquery/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../js/localsite.js" id="http://localhost:8887/localsite/js/localsite.js"></script>
<script type="text/javascript" src="../js/navigation.js"></script>
<script type="text/javascript" src="../js/showdown.min.js"></script>
<script type="text/javascript" src="../js/d3.v5.min.js" id="http://localhost:8887/localsite/js/d3.v5.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<!-- PRODUCTION -->
<!-- resides before base.css -->
<!--
<link rel="stylesheet" type="text/css" href="../../localsite/css/bootstrap.darkly.min.css"/>
-->
<link rel="stylesheet" type="text/css" href="../../io/build/widgets.css">
<script src="../../io/build/lib/useeio_widgets.js"></script>

<!-- LOCAL DEV -->
<!--
<link rel="stylesheet" type="text/css" href="../../input-output/build/widgets.css">
<script src="../../input-output/build/lib/useeio_widgets.js"></script>
-->

<script type="text/javascript" src="../js/naics.js"></script>
<link type="text/css" href="../css/naics.css" rel="stylesheet" />

<!-- Has to be included for county map recall withou error, since loading from dual map widget does not work. -->
<script type="text/javascript" src="/localsite/js/leaflet.js" id="/localsite/js/leaflet.js"></script>

<!-- After USEEIO to alter css -->
<!--
<link type="text/css" href="../../localsite/css/base.css" rel="stylesheet" />
<link rel="stylesheet" href="../css/community.css" />
-->

<script>
	$(document).ready(function () {
		let startsWith13 = true; // To do - change to check array
		if (!param.geo || startsWith13) {
			//param.titleArray = ["Georgia"]
			//param.headerLogo = "<img src='/community/img/logo/georgia-icon.png' style='width:64px'>";
		}
	    $(window).scroll(function(){$(".herocenter").css("opacity", 1 - $(window).scrollTop() / 200);});
	});
</script>

<style>
#logoholderX { margin-top: -8px; }
#pageLinksHolder { display:block !important; margin-top: 55px;}

.fade-in {
  animation: fadeIn ease 4s;
}
@keyframes fadeIn {
  0% {
    opacity:0;
  }
  100% {
    opacity:1;
  }
}

.headerOffset2 {
	display: none !important;
}
/* Temp overrides */
.mock-up {
	displayX: inline-block !important;
}
.top-content-columns-wide {
	width:100% !important;
	max-width: 3000px !important;
	margin-left: 20px !important;
}
.indicator-row {
    height: auto;
}
#list_mainX {
	display:none;
}
.data-section { /* shown when show=suppliers */
	display:none;
}
.markdownEye {
	display:none;
}
.searchElements {
	display: block !important;
}
#map1 {
	height:350px;
}
#data {
	displayX: none !important;
}

code {
	max-width: 500px;
	overflow: scroll;
}
.headerImage {
	display:none;
}
.littleHeader {
	border-bottom: 1px solid #ccc;
	padding-bottom:5px;
	margin-bottom:5px;
}


.module_h1XX {
	font-size:28px;
	font-weight: 200;
	padding-top:0px;
	margin-top:0px;
	margin-bottom:20px;
	border-bottom: 1px solid #ddd;
}
.pageColumns {
	margin:0 10px 0 0px;
	display: table;
	max-width:1800px;
}
.mainColumn {
	display:table-cell;
	vertical-align: top;
}
.mainColumn1 {
	min-width: 500px;
	width: 500px;
	padding-right: 50px
}
@media (max-width: 800px) {
	.mainColumn {
		display: block;
	}
	.mainColumn1 {
		width: 100%;
	}
}


#sector_list a:visited {
    color: #333;
}
#sector_list a:link {
    color: #333;
}

.io-arrow {
	font-size: 64px;
	position: absolute;
	right: -13px;
	top: 250px;
	z-index: 10;
	color: #f47d22;
	color: #63a750;
}

/*
.industryBucket {
	width:33%;
	float:left;
	position: relative;
}
.industryBucketPadding {
	border: 1px solid #ccc;
	padding:15px;
	margin-right: 30px;
	overflow: hidden;
}
.industryBucketPaddingMosaic {
	padding: 0px;
	padding-top: 50px;
	border: none;
	margin-right: 0px;
}
.sectorBucketMosaic {
	width:auto;
	max-width:auto;
}
.tab-2{
	display: inline-block;
    margin-left: 140px;
}
@media (max-width: 800px) {
	.industryBucket {
		width: 100%;
		margin-bottom: 30px;
	}
	.industryBucketPadding {
		margin-right: 0px;
	}
	.io-arrow {
		display: none;
	}
}
*/


.picklist {
	margin-bottom:8px;
}
.industry_filter_settings {
	padding: 20px;
	border: 1px solid #ccc;
	border-radius: 10px;
	margin-bottom: 8px;
	display: none;
}
.leaflet-top > .info {
	background-color: rgba(33, 33, 33, 0.5);
	color: #fff;
	padding: 10px;
	text-align: center;
	min-width: 130px;
}
</style>
  

<script>
document.addEventListener('hashChangeEvent', function (elem) {
	console.log("info/index.html detects hashChangeEvent");
 	refreshWidgets();
}, false);

function reloadMapTiles(whichmap,attempt) {
	if ($('#geomap').html().length > 0) {
		if (document.querySelector(whichmap)._leaflet_map) { // Give time for next line to be found.
			document.querySelector(whichmap)._leaflet_map.invalidateSize();
		} else {
			console.log("reloadMapTiles " + whichmap + ". Attempt " + attempt);
			if (attempt < 100) {
				setTimeout( function() {
					reloadMapTiles(whichmap,attempt+1)
				}, 50 );
			} else {
				// Try anyway
				//console.log("reloadMapTiles - try anyway");
				//document.querySelector(whichmap)._leaflet_map.invalidateSize(); // Still returns error.
			}
		}
	}
}
// INIT
//var hash = getHash(); // Include all existing
var priorHash = {};
function refreshWidgets() {
	let reloadedMap = false;
	param = loadParams(location.search,location.hash); // param is declared in localsite.js
	let hash = getHash();
	//alert("refreshWidgets from prior geo: " + priorHash.geo + " to " + hash.geo);
	
	// NOTE: params after ? are not included, just the hash.
	if (hash.go != priorHash.go) {
		if (hash.show == priorHash.show) {
			hash.show = ""; // Clear the suppliers display
		}
		updateText(hash.go);
	}
	if (hash.geomap) {
		$("#infoColumn").show();
        $(".mainColumn1").show();
	}
	if (hash.geomap != priorHash.geomap) {
		if (hash.geomap) {
			$("#aboutToolsDiv").hide();
			$("#infoColumn").show();
			$("#geomap").show();
			
			// DOES NOT WORK - document.querySelector(whichmap)._leaflet_map not found
			//reloadMapTiles('#geomap',1);
			
			// Reload map instead
			if (reloadedMap == false) {
				loadScript('/localsite/js/leaflet.js', function(results) {
					let whichmap = "geomap";
						let map = document.querySelector('#' + whichmap)._leaflet_map; 
						if (map) {
							if (geojsonLayer) {
								// removes the whole layer until 
								map.removeLayer(geojsonLayer); // Remove the prior topo layer
							}
						}
					renderMapShapes(whichmap, hash); // Temp here
					reloadedMap = true;
				});
			}
			/*
			alert("show map")
			if (document.querySelector('#geomap')._leaflet_map) {
				alert("redraw map")
				document.querySelector('#geomap')._leaflet_map.invalidateSize(); // Refresh map tiles.
			}
			*/
			
		} else {
			$("#geomap").hide();
			$("#aboutToolsDiv").show();
		}
	}
	if (hash.show != priorHash.show) {
		if (hash.show == "farmfresh") {
			$(".data-section").show();
		} else if (hash.show == "suppliers") {
			$(".data-section").show();
			$(".suppliers").show();
		} else {
			$(".data-section").hide();
			$(".suppliers").hide();
		}
	}
	if (hash.geo != priorHash.geo) {
		if (hash.geo && hash.geo.length > 4) { 
			$(".state-view").hide();
        	$(".county-view").show();
        	$(".industry_filter_settings").show(); // temp
		} else {
			$(".county-view").hide();
        	$(".state-view").show();
        	$(".industry_filter_settings").hide(); // temp
		}
		if (hash.geo) {
			if (hash.geo.split(",").length >= 3) {
		        $("#top-content-columns").addClass("top-content-columns-wide");
		    } else {
		    	$("#top-content-columns").removeClass("top-content-columns-wide");
		    }
		} else {
	        $("#infoColumn").show();
	        $(".mainColumn1").show();
	    }

	    //if (hash.geomap == "true") { // Since otherwise called above
	    	if (reloadedMap == false) {
		    	loadScript('/localsite/js/leaflet.js', function(results) {

			    		// ._leaflet_map Only works if alert occurs here
			    		//alert("reloadedMap2 " + reloadedMap)

			    		//alert("update map")
						//renderMapShapesSimple("geomap", hash);

						// Clear here so clicking a new region redraws map.
						// This can be avoided once we figure out how to update an individal shape using renderMapShapesSimple.
						let whichmap = "geomap";
						let map = document.querySelector('#' + whichmap)._leaflet_map; 
						if (geojsonLayer) {
							// removes the whole layer until 
							map.removeLayer(geojsonLayer); // Remove the prior topo layer
						}
						//alert("render")
						renderMapShapes(whichmap, hash); // Temp here

				});
				reloadedMap = true;
			}
		//}
	}
	//alert(hash.regiontitle)
	if (hash.regiontitle != priorHash.regiontitle) {
		if (hash.go) {
			$(".regiontitle").text(hash.regiontitle + " - " + hash.go.toTitleCase());
		} else {
			$(".regiontitle").text(hash.regiontitle);
		}
	}

	if (hash.geo != priorHash.geo) {
		//$(".regiontitle").text(""); //Clear
		//$(".location_titles").text(""); //Clear
		//updateLoc(hash.geo); // Check counties. (map-filters.js)
	}
	

    if (param.catsort) {
		$("#catsort").val(param.catsort);
	}
	if (param.catsize) {
		$("#catsize").val(param.catsize);
	}
	if (param.catmethod) {
		$("#catmethod").val(param.catmethod);
	}
	if (param.indicators) {
		$("#indicators").val(param.indicators);
	}
	priorHash = getHash();
}
</script>

</head>

<body>

<!-- to do: load top hero here when no go or geo. -->


<!-- location filters, location map and list -->
<!-- optional: ?show=smart -->

<script type="text/javascript" src="../js/map-embed.js"></script>
<!-- /location filters, location map and list -->

<div style="clear:both"></div>


<!--
To do: make the links below an optional widget
<div id="pageLinks"></div>
-->

<div id="top-content-columns" class="content contentpadding noprint" style="margin-top:20px; padding-top:0px; padding-bottom:0px">

	<div style="padding-top:0px; padding-bottom:0px">

	<div id="topMessage"></div>

	<!-- two columns -->
	<div class="pageColumns">
		<div style="display:table-row">
			<div id="infoColumn" class="mainColumn mainColumn1" style="font-size: 15px; position: relative">

				<!--
				<div style="max-width:400px; margin-bottom:10px">
				Adjust your local industry mix to maximize job quality, 
				value added revenue and positive environmental&nbsp;impacts.
				</div>
				-->

				<!-- Must be displayed initiallly so tiles are visible -->
				<div id="geomap" style="height:550px; border:1px solid blue; position: relative"></div>

				
				<div id="aboutToolsDiv" style="position: relative;"></div>
				
			</div>

			<div class="mainColumn mainColumn2 input-output">
			
				<div>
					<h2 class="regiontitle" style="margin-top:0px;padding-top:0px;">Loading Industries...</h2>
					<h4 class="location_titles" style="font-size:16px;color:#555;display:none"></h4>
				</div>

				<!--
				<div style="max-width:700px">
					<b>Adjust Industry Levels</b> to reflect technology initiatives that generate new revenue streams, create jobs and increase your community's positive environmental impact.
				</div>
				<br><br>
				-->

				<div id="detail_selection">
					<div id="show_industry_settings" style="float:right;cursor:pointer" onclick="$('.industry_filter_settings').toggle();">
						<span class="material-icons" style="font-size:24px;color:#777">
						settings
						</span>
					</div>
					<select id="catsort" class="picklist" onchange="goHash({'catsort':this.value});">
			          <option value="payann" selected>By Annual Payroll</option>
			          <option value="emp" >By Employee Count</option>
			          <option value="estab">By Establishments</option>
			        </select>
			        <select id="catsize" class="picklist" onchange="goHash({'catsize':this.value});">
			          <option value="2">Sectors - 2 digits</option>
			          <!--option value="2">Subsectors - 3 digits</option-->
			          <option value="4">Industry Group - 4 digits</option>
			          <!--option value="4">NAICS Industry - 5 digits</option-->
			          <option value="6" selected>National Code - 6 digits</option>
			        </select>
			        <div style="clear:both;margin-bottom:2px"></div>

			        <div class="industry_filter_settings">
				        <div class="state-view">
				        	Choose a county or region above to view filter settings.
				        </div>
				        <div class="county-view" style="display:none">
					        <select id="catmethod" class="picklist" onchange="goHash({'catmethod':this.value});">
					          <option value="1" selected>Average of unallocated county payrolls</option>
					          <option value="2" >Average of all state payrolls (less accurate)</option>
					          <option value="0" >Leave unpublished values blank</option>
					        </select>
					    </div>
					</div>

					<!--
					The US Census does not provide stats for 2-digit manufacturing NAICS 31, 32&nbsp;and&nbsp;33.<br><br>
					-->
				</div>

				
				
				<div id="econ_list"></div>
				<br>
				<div class="mock-up" style="display:none">
					Change scales to view the impact of different industry mixes. (Not yet activated)<br>
				</div>
				<!-- /Sector List Format -->

				

			</div>
		
		</div>
	</div>
	<!-- /two columns -->

</div>
</div>

<!-- INPUT OUTPUT -->
<div class="content contentpadding litePanel" style="width:95% !important; max-width:95%; margin-top:20px; border:1px solid #aaa">

<div style="margin-right:45px">
	<h2 style="border:0px" id="infoHeaderX">Supply Chain Impact</h2>
	<hr>

	<div style="float:right;margin-bottom:16px" class="noprint">
		<a href="https://model.earth/io/charts/">About Widgets</a>
	</div>
</div>


	<div style="display:none">
		<div style="font-size: 15px;">
			<input name="sector_action" type="radio">
			Recruit a new industry<br>
			<input name="sector_action" type="radio">
			Transform an existing industry<br>
			<br>
		</div>
	</div>



Choose commodities below to view upstream input and downstream output.<br>

<div class="pageColumns">

    <div class="pageColumn">
      <div class="pageColumnInside">
          <h2>Upstream</h2>
          Input from Suppliers
          <div id="inputs" class="industry-list">
          </div>
      </div>
    </div>

    <div class="pageColumn">
      <div class="pageColumnInside">
        <h2>Commodities</h2>
        <div>Georgia Manufacturers</div>
        <div id="industry-list" class="industry-list">
        </div>
      </div>
    </div>

    <div class="pageColumn">
      <div class="pageColumnInside">
        <h2>Downstream</h2>
          Output to Buyers
          <div id="outputs" class="industry-list">
          </div>
      </div>
    </div>

</div>

<style>
.industry-list {
	padding-right:50px;
	font-size: 11px;
}
.matrix-search {
	display: none;
}
</style>


<!-- change endpoint when adding to page -->

<script>
function applyIO(naics) { // Called from naics.js
    var modelID = 'USEEIO';

    var model = useeio.model({
        endpoint: '/io/build/api',
        model: modelID,
        asJsonFiles: true,
    });

    var inputs = useeio.inputList({
        model: model,
        selector: '#inputs',
    });

    var industryList = useeio.industryList({
        model: model,
        selector: '#industry-list',
    });

    var outputs = useeio.outputList({
        model: model,
        selector: '#outputs',
    })

    /*
    var naics = '11,45,62,211,314,331,425,452,488,521,561,721,925,1122,'
        + '1151,2213,2389,3121,3161,3251,3272,3322,3333,3346,'
        + '3366,4234,4245,4422,4482,4541,4851,4872,4922,5174,'
        + '5239,5323,5418,5619,6117,6223,7112,7213,8123,9231,'
        + '11115,11192,11233,11311,21221,22121,23721,23819,'
        + '23891,31142,31193,31322,31519,32121,32229,32519,'
        + '32591,32621,32741,33149,33251,33324,33422,33531,'
        + '33633,33711,33995,42333,42352,42383,42412,42444,'
        + '42469,42499,44221,44512,44711,44832,45321,45439,'
        + '48423,48691,48833,49312,51212,51521,52111,52239,'
        + '52411,52599,53212,54111,54137,54171,54191,56133,'
        + '56161,56211,61143,62132,62199,62412,71119,71311,'
        + '72111,81111,81219,81311,92111,92215,92512,111120,'
        + '111320,111421,112112,112420,113310,115116,212222,'
        + '212322,213114,221121,236210,238130,238320,311212,'
        + '311352,311520,311824,312111,313230,315190,321113,'
        + '321920,322219,324121,325199,325413,325991,326150,'
        + '327120,327410,331222,331512,332215,332431,332813,'
        + '332999,333249,333517,333922,333999,334416,334516,'
        + '335221,335921,336212,336390,336991,337212,339910,'
        + '339999,423390,423610,423840,424130,424450,424710,'
        + '425110,442210,444220,446110,448140,451211,453910,'
        + '454390,483113,485111,485999,488190,488999,511130,'
        + '512199,517110,521110,522294,523910,524130,525990,'
        + '532111,532411,541213,541380,541612,541820,541930,'
        + '561320,561492,561622,562112,611110,611610,621310,'
        + '621493,622310,624210,711211,712190,713990,722330,'
        + '811121,811411,812210,812990,813920,921190,923130,'
        + '926150';
	*/
    //naics = '221100'; // TEMP
    //naics = '';

    // Add bioeconomy
    //naics = naics + "311615,311812,321113,221112,113310,322110,311821,311612,325211,311813,311911,311919,311830,311119,322121,311824,311941,325991,311710,311930";

    var naicsCodes = naics.split(',');
    var handled = {};
    var beaCodes = naicsCodes.map(useeio.toBEA)
        .filter(function (code) {
            // remove unmapped codes and duplicates
            if (!code || handled[code])
                return false;
            handled[code] = true;
            return true;
        });

    var config = {
        count: 40,
        naics: naicsCodes,
        sectors: beaCodes,
    };

    inputs.update(config);
    outputs.update(config);
    industryList.update(config);
    industryList.onChanged(function (change) {
        for (var prop in change) {
            if (change.hasOwnProperty(prop)) {
                config[prop] = change[prop];
            }
        }
        inputs.update(config);
        outputs.update(config);
        industryList.update(config);
    });
}
</script>

</div>
<div style="clear:both;"></div>
<br><br>
<!-- /INPUT OUTPUT -->


<!-- MOSAIC HEATMAP -->
<style>
::-webkit-scrollbar {
   -webkit-appearance: none;
   width: 7px;
}
::-webkit-scrollbar-thumb {
   border-radius: 4px;
   background-color: rgba(0,0,0,.5);
   -webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);
}
</style>
<br><br>
<div class="content contentadding">
	<div style="float:right;margin-bottom:16px" class="noprint">
		<a href="https://model.earth/io/charts/">About Mosaic</a>
	</div>

	<h2 style="border-bottom: 0px">Environmental Indicators</h2>
    <div class="io" style="overflow-x: scroll">
        <div style="margin: 0 auto;">
            <div class="matrix-title">Goods & Services</div>
            <div style="clear:both"></div>

            <!--
            	location.reload() is a temporary fix since mosaic is not triggered by change to hash.
            -->
			<select id="indicators" class="filterClickX form-selectX picklist" onchange="goHash({'indicators':this.value});location.reload();" style="width: 450px;margin-bottom:0px">

			<option value="">Industries with top impacts...</option>

			<option value="JOBS,VADD">Positive Impacts:</option>

			<option value="JOBS">&nbsp; &nbsp;Jobs (JOBS)</option>
			<option value="VADD">&nbsp; &nbsp;Value Added (VADD)</option>


			<option value="ENRG,LAND,WATR">Resource Use:</option>

			<option value="ENRG" title="Energy Use (ENRG): 
			Energy Use is an indicator of the life cycle total amount of primary energy used as defined by heat value in a combusted resource or the available energy in a renewable resource to a converting device such as a wind turbine or water turbine. This indicator is a combination of the NNRG and RNRG indicators. This indicator is expressed in megajoules (MJ).">&nbsp; &nbsp;Energy Use (ENRG)</option>

			<option value="WATR" title="Water Use (WATR): 
			Water Use is an indicator of the life cycle total amount (m3) of freshwater withdrawn from surface and groundwater sources in order to provide a given good or service to society.">&nbsp; &nbsp;Water Use (WATR)</option>

			<option value="LAND" title="Land Use (LAND): 
			Nearly every process requires some amount of land for factories, offices, or roads. This land is often converted from existing natural habitats for wildlife. Habitat loss is the leading cause of wildlife extinctions worldwide and additional habitat conversion could lead to further loss of species. This indicator tracks the total area of usable land occupied to allow for the process. This indicator is expressed in square meters for a year (m2*yr).">&nbsp; &nbsp;Land Use (LAND)</option>

			<option value="">Impact Potential:</option>

			<option value="ACID" title="Acid Rain (ACID): 
			Acid rain occurs when acid-precursors are absorbed from the atmosphere by clouds and dissolved in falling rain. Acid rain, while not directly dangerous to people, causes millions of dollars in damage to infrastructure by very slowly dissolving the exposed surfaces of roads, buildings, drains, and even statues. Acid rain is also detrimental to natural life: acidic soils make it difficult or impossible for plants to survive and grow and acidic runoff can disrupt the delicate chemical balance in natural bodies of water. In this indicator, emissions are expressed in sulfur dioxide (SO2) equivalents. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Acid Rain (ACID)</option>

			<!--
			<option value="CCDD" title="Commercial Construction and Demolition Debris (CCDD): 
			The CCDD indicator represents the annual generation amount of construction and demolition (C&amp;D) materials during the construction, renovation and demolition of buildings (including homes), roads, bridges and other structures. C&amp;D materials include steel, wood products, drywall and plaster, brick and clay tile, asphalt shingles, concrete and asphalt concrete. The CCDD indicator does not include C&amp;D debris from DIY renovations or natural disasters. This indicator is expressed in kilograms (kg).">&nbsp; &nbsp;Commercial Construction and Demolition Debris (CCDD)</option>
			
			<option value="CMSW" title="Commercial Municipal Solid Waste (CMSW): 
			EPA refers to trash, or municipal solid waste (MSW), as various items consumers throw away after they are used. These items include bottles and corrugated boxes, food, grass clippings, sofa, computers, tires and refrigerators. However, MSW does not include everything that is landfilled in MSW, or nonhazardous, landfills, such as construction and demolition debris, municipal wastewater sludge, and other non-hazardous industrial wastes. These wastes come from: our homes; institutions such as schools and hospitals; and commercial sources such as restaurants and businesses. The CMSW indicator includes MSW found in the dumpsters of commercial and institutional entities. It does not include MSW from homes. Data for CMSW comes from this 2014 CalRecycle report (https://www2.calrecycle.ca.gov/Publications/Details/1543). This indicator is expressed in kilograms (kg).">&nbsp; &nbsp;Commercial Municipal Solid Waste (CMSW)</option>
			

			<option value="CRHW" title="Commercial RCRA Hazardous Waste (CRHW): 
			Hazardous wastes are wastes with properties that make them dangerous or capable of having a harmful effect on human health or the environment. Hazardous waste is generated from many sources, ranging from industrial manufacturing process wastes to batteries and may come in many forms, including liquids, solids, gases and sludges. EPA identifies hazardous waste and collects information on quantities generated through its Biennial Hazardous Waste Report. Individual states can identify hazardous waste beyond what EPA identifies. Unless otherwise specified, quantities reflected in this indicator come from EPA's Biennial Report. This indicator is expressed in kilograms (kg).">&nbsp; &nbsp;Commercial RCRA Hazardous Waste (CRHW)</option>
			-->


			<option value="EUTR" title="Eutrophication (EUTR): 
			Aquatic life is frequently limited by access to mineral nutrients, but the most common limiting nutrients are in both agricultural fertilizers and sewage. When these nutrients are carried in to natural water bodies, usually by rain or pipe, they can cause massive blooms of algae. These algae can choke out other life in the water by rapidly taking up oxygen, blocking sunlight, or even releasing toxic chemicals. After the bloom, the algae die and leave behind a devastated ecosystem. In this indicator, emissions are expressed as their equivalent in kilograms of bioavailable nitrogen, based on the emission in question's potential to reach a body of water and its resultant impacts on algal growth. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Eutrophication (EUTR)</option>

			<option value="ETOX" title="Freshwater Aquatic Ecotoxicity (ETOX): 
			Like humans, wildlife can be harmed by exposure to toxic chemicals and substances. An ever-expanding list of common chemicals have been assessed for their tendency to cause ecological damage when released in to the air, water, or soil. In this indicator, emissions are expressed in terms of their contribution to ecological damage in the water column of freshwater bodies. A standardized Comparative Toxicity Unit is used. The source of the factors for this indicator is TRACI 2.1 (Bare 2012) which uses USETox 1.0 (Rosenbaum et al. 2008).">&nbsp; &nbsp;Freshwater Aquatic Ecotoxicity (ETOX)</option>

			<!--
			<option value="GHG" title="Greenhouse Gases (GHG): 
			Greenhouse gases are the primary driver of climate change. These gases absorb infrared radiation emitted by the sun at a higher rate than standard atmospheric gases. The result is that, when these gases are emitted, the atmosphere absorbs and stores more heat, causing it to warm up. Carbon dioxide is the most commonly known greenhouse gas, but other gases such as methane, nitrous oxide, and even water vapor are all major contributors to the warming of the atmosphere. In this indicator, emissions are expressed as their equivalent in carbon dioxide (CO2), based on the amount of heat they can absorb and their average life span in the atmosphere. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Greenhouse Gases (GHG)</option>
			-->

			<option value="HRSP" title="Human Health - Respiratory Effects (HRSP): 
			Particulates can be nearly any ingestible material ground down to a fine enough size. Even otherwise harmless substances, when suspended as a dust and inhaled in to the lungs, can clog airways and irritate the sensitive tissues of the lungs. Over time, exposure to these particulates can lead to a variety of harmful respiratory and cardiac diseases and a general loss of cardiopulmonary function that significantly lowers both lifespan and productive years. In this indicator, emissions are expressed in terms of their effect on human respiratory health in PM2.5 equivalents. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Human Health - Respiratory Effects (HRSP)</option>

			<option value="HTOX" title="Human Health Toxicity (HTOX): 
			Millions of tons of chemicals are used in commerce that a human can be exposed to with potential detrimental effect. Exposure to certain chemicals can increase the likelihood of cancer or other illness in humans. In this indicator, emissions are expressed in terms of their contribution to the incidence of cancer and illness in humans. A standardized Comparative Toxicity Unit (CTU) is used. This indicator is a combination of the HCAN and HNCN indicators. The source of the factors for this indicator is TRACI 2.1 (Bare 2012) which uses USETox 1.0 (Rosenbaum et al. 2008).">&nbsp; &nbsp;Human Health Toxicity (HTOX)</option>

			

			<!--
			<option value="MNRL" title="Minerals and Metals Use (MNRL): 
			Minerals and Metals Use is an indicator of the life cycle total mass of nonmetallic and metallic minerals extracted for use measured in kilograms (kg).">&nbsp; &nbsp;Minerals and Metals Use (MNRL)</option>
			-->

			<option value="OZON" title="Ozone Depletion (OZON): 
			The earth is surrounded by a protective layer of atmospheric ozone that filters out harmful radiation from the sun. Certain chemicals, when released in to the air, have the ability to react with and destroy large quantities of the ozone layer, allowing more harmful radiation to reach us. Some chemicals are more long lasting or more likely to interact with ozone than others, so they have different destructive potentials. In this indicator, emissions are expressed as their equivalent in kilograms of CFC-11, an extremely harmful gas formerly used as a common refrigerant capable of destroying thousands of times its mass in ozone. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Ozone Depletion (OZON)</option>

			<option value="SMOG" title="Smog Formation (SMOG): 
			Smog formation is a complex process by which a group of inorganic gases, typically released by the burning of fossil fuels, react with another group of organic substances, typically released by plant-life, to create ozone at the ground-level. Ozone created at the ground level can cause respiratory disease in humans and stresses plant life, making them more susceptible to disease. Ground-level ozone is also generally broken down and destroyed before it can rise up to join the protective atmospheric ozone layer. In this indicator, emissions are expressed in terms of how much they will contribute to the creation of ground-level ozone (O3), units are kg O3 -equivalents. The source of the factors for this indicator is TRACI 2.1 (Bare 2012).">&nbsp; &nbsp;Smog Formation (SMOG)</option>

			<option value="METL,PEST">Chemical Releases:</option>
			<option value="METL">&nbsp; &nbsp;Metal (METL)</option>
			<option value="PEST">&nbsp; &nbsp;Pesticides (PEST)</option>

			</select>
			<br><br>

            <div class="industry-list-mosaic">
            </div>
        </div>
    </div>
</div>

<script>
function updateMosic(naics) {
    var config = useeio.urlConfig();
    var modelID = config.get().model || 'GAUSEEIO';

    var model = useeio.model({
        endpoint: '/io/build/api',
        model: modelID,
        asJsonFiles: true,
        view: 'mosaic',
    });

    //naics = "311615,311812,321113,221112,113310,322110,311821,311612,325211,311813,311911,311919,311830,311119,322121,311824,311941,325991,311710,311930";

    var naicsCodes = naics.split(',');

    var industryListMosaic = useeio.industryList({
        model: model,
        selector: '.industry-list-mosaic',
    });
    config.withDefaults({
    	view: 'mosaic',
        count: 15,
        naics: naicsCodes,
    });
    config.join(industryListMosaic);
}
function updateMosicNew(naics) {
	// Might not use this, unless it can be revised to allow the hash to trigger when indicators dropdown changes. Remove location.reload() above.
	var modelID = 'USEEIO';

    var model = useeio.model({
        //endpoint: 'https://useeiowidgets.imfast.io/api',
        endpoint: '/io/build/api',
        model: modelID,
        asJsonFiles: true,
        view: 'mosaic'
    });

    var industryList = useeio.industryList({
        model: model,
        selector: '.industry-list-mosaic',
    });

    var naicsCodes = naics.split(',');
    var handled = {};
    var beaCodes = naicsCodes.map(useeio.toBEA)
        .filter(function (code) {
            // remove unmapped codes and duplicates
            if (!code || handled[code])
                return false;
            handled[code] = true;
            return true;
        });

    var config = {
        count: 30,
        view: 'mosaic',
        naics: naicsCodes,
        sectors: beaCodes,
    };

    //inputs.update(config);
    //outputs.update(config);
    industryList.update(config);
    industryList.onChanged(function (change) {
        for (var prop in change) {
            if (change.hasOwnProperty(prop)) {
                config[prop] = change[prop];
            }
        }
        //inputs.update(config);
        //outputs.update(config);
        industryList.update(config);
    });
}
</script>
<!-- /MOSAIC HEATMAP -->


<!--
config.withDefaults({
  view: ['mosaic'],
  count: 20,
});
config.join(industryList);


https://www.epa.gov/enviroatlas

<div class="contentpadding">
<h1>Sample of embedding <a href="https://www.epa.gov/enviroatlas/enviroatlas-interactive-map">Enviro Atlas</a></h1>
</div>
<iframe src="https://epa.maps.arcgis.com/apps/MapJournal/index.html?appid=0659c53852f4425fb3460e78de67a3ef" style="width:100%;height:800px; margin-bottom:40px"></iframe>
-->


<div style="margin:0 30px 0 30px; max-width: 2000px;">
	
	<!--
	<h1 class="module_h1">My Local Area</h1>

	Click columns to sort. Choose geo to define your local area. (Activating shortly.)<br><br>

	<div style="width:100%" class="output_table2 rotateHeader"></div>
	<br>
	-->

	<!--
		<div style="padding:40px">
		5-digit NAICS are the same in Canada, Mexico and the US.<br>
		6-digit NAICS are country-specific. 
		</div>
	-->

	<div id="bioenergySummaryDiv"></div>

</div>
<br>




<!-- Warning: adding content class causes popups to disappear because the absoulte top is using the top of page. -->
<div class="contentX contentpadding" style="margin-left:30px">

	<link rel="stylesheet" type="text/css" href="../../io/charts/bubble/css/bubble.css"/>


	<div class="bubble-graph">

		<div style="float:right;margin-bottom:16px" class="noprint">
			<a href="https://model.earth/io/charts/">About Bubble Chart</a>
		</div>

        <h2 style="border-bottom: 0px">Impact Bubble Chart</h2>
        <div id="bubble-graph-title"></div>
        <text id="bubble-graph-equation"></text>

      <div style="clear:both; border-top:1px solid #999; border-bottom:1px solid #999; padding:10px; margin-bottom:10px; overflow: scroll">

        <div id="graph-wrapper-z">
            <text class="text-space-horz">Bubble-Size</text>
            <select id="graph-picklist-z" class="graph-picklist">
            </select>
            <span id="unit-z"></span>
          </div>

        <div id="graph-wrapper">

    
          <div id="graph-wrapper-y">
            <text class="text-space-vert">Y-Axis</text>
            <select id="graph-picklist-y" class="graph-picklist">
            </select>
            <span id="unit-y"></span>
          </div> 

        </div>
        <div id="graph-wrapper-x">
            <text class="text-space-horz">X-Axis</text>
            <select id="graph-picklist-x" class="graph-picklist">
            </select>
            <span id="unit-x"></span>
         </div> 
         

      </div>


      <div>
       
        <label  style="float:left; margin-right:6px" class="switch">
          <input id="mySelect" type="checkbox" checked>
          <span class="slider round"></span>
        </label>
        <div class="switch-text">
          Top industries within region
        </div>

      </div>


  	</div>
  	<button onclick="clearBubbleSelection()">Clear Selection</button>
  	<div style="clear:both"></div>

</div>

<div class="content contentpadding" style="padding-top: 0px">
	<!-- Saving for later -->
	<div id="barchart" style="display:none"></div>

	<div id="impactTextIntro" class="noprint">Click bubbles above to display a bar chart below for comparison.</div>
	<div id="impactText" style="float:left"></div>
	<div style="clear:both"></div>


	<script type="text/javascript" src="../../io/charts/bubble/js/bubble.js"></script>


	<div class="io" style=" max-width: 850px; margin: auto;">
	        <h1 class="text-center">Impact chart</h1>
	        <p>
	            The impact chart widget shows the environmental profile of one or more sectors.
	        </p>
	        <div id="impact-chart" class="impact-chart" style="display:none">
	        	
	        </div>
	</div>


	<div id="sector-list" class="sector-list"></div>
</div>

<script>
    var config = useeio.urlConfig();
    var modelID = config.get().model || 'GAUSEEIO';
    var model = useeio.model({
      endpoint: '/io/build/api',
      model: modelID,
      asJsonFiles: true,
    });
     var svg3 = d3.select("#impact-chart")
      .append("div")
      .attr('id', 'imp');
    var impactChart = useeio.impactChart({
      model: model,
      selector: '#impt',
      columns: 3,
      width: 800,
      height: 300,
    });
    selected_sector=""
    impactChart.update({
        sectors: [selected_sector],
    });

    //update the chart if the sector-list changes.
    var element = document.querySelector('#sector-list');
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type == "attributes") {
          selected_sector1=document.getElementById('sector-list').getAttribute('sector')
          if(typeof selected_sector1 == "undefined" || selected_sector1==null){
            selected_sector1=[]
            selected_sector=[]
          }else{
            selected_sector=selected_sector1.split(',')
          }
          selected_model=document.getElementById('sector-list').getAttribute('area')
          d3.select("#imp").remove();
          var svg3 = d3.select("#impact-chart")
            .append("div")
            .attr('id', 'imp');
          var config = useeio.urlConfig();
          var modelID = config.get().model || selected_model;
          var model = useeio.model({
            endpoint: '/io/build/api',
            model: modelID,
            asJsonFiles: true,
          });
          var impactChart = useeio.impactChart({
            model: model,
            selector: '#imp',
            columns: 3,
            width: 800,
            height: 300,
          });
          impactChart.update({
            sectors: selected_sector,  
          });
        }
      });
    });

    observer.observe(element, {
      attributes: true //configure it to listen to attribute changes
    });
</script>
<br><br><br><br>




<div class="content contentpadding" style="display:none">
	<h2 class="module_h1" style="margin-bottom:10px">Set priorities for your community</h2>
	<br>

	<div style="float:left; margin-right:30px">
	<div class="littleHeader">Currently Quantifiable</div>
	Evaluate a Specific Technology<br>
	Increase Local Revenue<br>
	Increase Employment<br>
	Increase Air Quality<br>
	Increase Water Quality<br>
	Increase Clean Energy<br>
	Increase Health and Wellness<br>
	<br><br>
	</div>

	<div style="float:left">
	<div class="littleHeader">Areas to Quantify</div>
	Increase Higher Paying Jobs<br>
	Increase Long-term Carbon Capture<br>
	Increase Access to Amenities<br>
	Increase Beauty in Land Use<br>
	Increase Green Material Use<br>
	Increase Total Satisfaction<br>
	</div>
	<div style="clear:both"></div>

</div>


<script type="text/javascript">
'use strict'; // Optional, make sure we are declaring variables.

/*
// COMMON - also resides in embed-map.js
function loadScriptXXXXXX(url, callback)
{
  if (!document.getElementById(url)) { // Prevents multiple loads.
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;
    script.id = url; // Prevents multiple loads.
    // Bind the event to the callback function. Two events for cross browser compatibility.
    script.onreadystatechange = callback;
    script.onload = callback;
    //$(document).ready(function () { // Only needed if appending to body
    var head = document.getElementsByTagName('head')[0];
    head.appendChild(script);
    //});
    console.log("loadScript loaded: " + url);
  } else {
    console.log("loadScript script already available: " + url);
    callback();
  }
  // Nested calls are described here: https://books.google.com/books?id=ZOtVCgAAQBAJ&pg=PA6&lpg=PA6
}
// END COMMON
*/

function updateText(go) {
	$("#aboutToolsDiv").text("");
	if (go == "bioeconomy") {
		loadMarkdown("https://model.earth/io/tools/bioeconomy-planner/about.md", "aboutToolsDiv", "_parent");
		//loadMarkdown("https://model.earth/io/tools/bioeconomy-planner/bioenergy/README.md", "bioenergySummaryDiv", "_parent");
	} else if (go == "dataprep") {
		loadMarkdown("../../localsite/info/data/README.md", "aboutToolsDiv", "_parent");
	} else if (go == "parts") {
		//loadMarkdown("https://model.earth/io/tools/localized-economy/about.md", "aboutToolsDiv", "_parent");
	} else {
		loadMarkdown("https://model.earth/io/tools/industry-impact/about.md", "aboutToolsDiv", "_parent");
	}

}
if (!param["go"]) {
	updateText("")
}

/*
document.getElementById('showValues').onclick = function() {
    // access properties using this keyword
    if ( this.checked ) {
        // if checked ...
        $(".output_table th.rotate > div > span").css("font-weight","600");
        $(".output_table td:nth-child(n+2) > div > div").css("visibility","visible");
        $(".output_table td:nth-child(n+2) > div > div").css("overflow","none");
        $(".output_table td:nth-child(n+2) > div").css("max-width","none");
        $(".output_table td:nth-child(n+2) > div").css("padding-left","5px");

        // Restore hidden columns
        $(".output_table th:nth-child(n+2)").css("display","table-cell");
        $(".output_table td:nth-child(n+2)").css("display","table-cell");
        
    } else {
        $(".output_table th.rotate > div > span").css("font-weight","400");
        $(".output_table td:nth-child(n+2) > div > div").css("visibility","hidden");
        $(".output_table td:nth-child(n+2) > div > div").css("overflow","auto");
        $(".output_table td:nth-child(n+2) > div").css("max-width","0px");
        $(".output_table td:nth-child(n+2) > div").css("padding-left","0px");

        // Hide entire column
        $(".output_table th:nth-child(n+2)").css("display","none");
        $(".output_table td:nth-child(n+2)").css("display","none");
    }
};
*/

// These is missing var promises = [] and ready.
// Let's look at Industry Mix first: http://localhost:8887/community/zip/leaflet/#columns=JobsAgriculture:50;JobsManufacturing:50
var geojsonLayer;
function renderMapShapesSimple(whichmap, hash) {
	console.log("renderMapShapesSimple " + whichmap);
	let map = document.querySelector('#' + whichmap)._leaflet_map; 
	//alert("renderMapShapesSimple " + whichmap);
	if (geojsonLayer) {
		//alert("found geojsonLayer")
	  	// Problem, this removes the whole layer, shapes and all.
		//map.removeLayer(geojsonLayer); // Remove the prior topo layer


	}

}
function renderMapShapes(whichmap, hash) { // whichGeoRegion is not yet applied.
	console.log("renderMapShapes " + whichmap);
	var req = new XMLHttpRequest();
	const whichGeoRegion = hash.geomap;
    // Topo data source
    //https://github.com/deldersveld/topojson/tree/master/countries/us-states

    // TOPO Files: https://github.com/modelearth/topojson
    var url = dual_map.custom_data_root() + '/counties/GA-13-georgia-counties.json';
    //if(location.host.indexOf('localhost') >= 0) {
    if (param.geo == "US01") { // Bug, change to get state from string, also below.
    	// https://github.com/modelearth/topojson/blob/master/countries/us-states/AL-01-alabama-counties.json
    	url = dual_map.modelearth_data_root() + "/topojson/countries/us-states/AL-01-alabama-counties.json";
    	//url = dual_map.modelearth_data_root() + "/opojson/countries/us-states/GA-13-georgia-counties.json";

    	// IMPORTANT: ALSO change localhost setting that uses cb_2015_alabama_county_20m below
	}
    //var layerControl_CountyMap = {}; // Object containing one control for each map on page.

    req.open('GET', url, true);
    req.onreadystatechange = handler;
    req.send();

    var topoob = {};
    var topodata = {};
    var neighbors = {};
    function handler(){

    if(req.readyState === XMLHttpRequest.DONE) {
//alert("render")
//map.invalidateSize();
      //map.addLayer(OpenStreetMap_BlackAndWhite)

      // try and catch json parsing of the responseText
      //try {
            topoob = JSON.parse(req.responseText)

            // Originated in community/map/leaflet/zips-sm.html
            // zips_us_topo.json
            // {"type":"Topology","objects":{"data":{"type":"GeometryCollection","geometries":[{"type":"Polygon

            // {"type":"Topology","transform":{"scale":[0.00176728378633945,0.0012459509163533049],"translate":

            //"arcs":[[38,39,40,41,42]],"type":"Polygon","properties":{"STATEFP":"13","COUNTYFP":"003","COUNTYNS":"00345784","AFFGEOID":"0500000US13003","GEOID":"13003","NAME":"Atkinson","LSAD":"06","ALAND":879043416,"AWATER":13294218}}

            // Was used by applyStyle
            ////neighbors = topojson.neighbors(topoob.objects.data.geometries);
            neighbors = topojson.neighbors(topoob.arcs); // .properties

            // ADD geometries  see https://observablehq.com/@d3/choropleth
            //topodata = topojson.feature(topoob, topoob.objects.data)

            //topodata = topojson.feature(topoob, topoob.transform)

            // 
            
            //if(location.host.indexOf('localhost') >= 0) {
            if (param.geo == "US01") {
            	topodata = topojson.feature(topoob, topoob.objects.cb_2015_alabama_county_20m)
        	} else {
        		topodata = topojson.feature(topoob, topoob.objects.cb_2015_georgia_county_20m)
        	}

            // ADD 
            // For region colors
            //mergeInDetailData(topodata, dp.data); // See start/maps/counties/counties.html



            // IS THIS BEING USED?
            //topodata.features = topodata.features.map(function(fm,i){
            /*
            topodata.features = topodata.features.map(function(fm,i){
                var ret = fm;
                //console.log("fm: " + fm.COUNTYFP);
                console.log("fm: " + fm.properties.countyfp);
                ret.indie = i;
                return ret
              });
            */

            //dp.data.forEach(function(datarow) { // For each county row from the region lookup table
              
              // All these work:
              //console.log("name:: " + datarow.name);
              //console.log("county_num:: " + datarow.county_num);
              //console.log("economic_region:: " + datarow.economic_region);

            //})

            //console.log('topodata: ', topodata)

            //geojsonLayer.clearLayers(); // Clear prior
            //        layerControl_CountyMap.clearLayers();

            

            //console.log('neigh', neighbors)
         //}
        //catch(e){
        //  geojson = {};
        //   console.log(e)
        //}


        //console.log(topodata)




      //// USA
      //var lat = 38.3;
      //var lon = -96.5;
      //var zoom = 5;

      // Georgia 32.1656° N, 82.9001° W
      var latX = 32.16;
      var lat = 32.69;
      var lon = -83.2;
      var lonX = -81.8;
      var zoom = 7;

      //var layer = "terrain";
      if (param.geo == "US01") { // Temp
      	lon = -86.7;
      }
      var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
          '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
          mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZWUyZGV2IiwiYSI6ImNqaWdsMXJvdTE4azIzcXFscTB1Nmcwcm4ifQ.hECfwyQtM7RtkBtydKpc5g';

      var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
          satellite = L.tileLayer(mbUrl, {id: 'mapbox.satellite',   attribution: mbAttr}),
          streets = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});

      var OpenStreetMap_BlackAndWhite = L.tileLayer('//{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });

      let dataParameters = {}; // Temp

      let map = document.querySelector('#' + whichmap)._leaflet_map; // Recall existing map

      var container = L.DomUtil.get(map);
      //if (container == null || map == undefined || map == null) { // Does not work
  	  if ($('#' + whichmap).html().length == 0) { // Note: Avoid putting loading icon within map div.

	      map = L.map(whichmap, {
		      center: new L.LatLng(lat,lon),
		      scrollWheelZoom: false,
		      zoom: zoom,
		      dragging: !L.Browser.mobile, 
		      tap: !L.Browser.mobile
		    });

	  }

	  if (map) {
		  if (geojsonLayer) {
		  	//alert("Remove the prior topo layer")
		  	// To do: 
		  	map.removeLayer(geojsonLayer); // Remove the prior topo layer
		  }

		  geojsonLayer = L.geoJson(topodata, {style:styleShape, onEachFeature: onEachFeature}).addTo(map); // Called within addTo(map)
	  } else {
	  	console.log("WARNING - map not available from _leaflet_map")
	  }

      var baseLayers = {
        "Open Street Map": OpenStreetMap_BlackAndWhite,
        "Grayscale Mapbox": grayscale,
        "Streets Mapbox": streets,
        "Satellite Mapbox": satellite
      };
      var overlays = {
        "Counties": geojsonLayer
      };


      var basemaps1 = {
	    'Grayscale' : L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
	    'Satellite' : L.tileLayer(mbUrl, {maxZoom: 25, id: 'mapbox.satellite', attribution: mbAttr}),
	    'Streets' : L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr}),
	    'OpenStreetMap' : L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	        maxZoom: 19, attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
	    }),
	  }

      //dataParameters.forEach(function(ele) {
        //overlays[ele.name] = ele.group; // Allows for use of dp.name with removeLayer and addLayer
        //console.log("Layer added: " + ele.name);
      //})

      //if(layerControl_CountyMap === false) { // First time, add new layer
        // Add the layers control to the map
      //  layerControl_CountyMap = L.control.layers(baseLayers, overlays).addTo(map);
      //}

      if (typeof layerControl != "undefined") {
      	//alert("OKAY: layerControl is available to CountyMap.")

      	// layerControl is declaired in map.js
      	if (layerControl[whichmap] != undefined) {
      		if (overlays["Counties"]) {
	      		// Reached on county click, but shapes are not removed.
	      		console.log("overlays: ");
	      		console.log(overlays);
	      		
	      		//resetHighlight(layerControl[whichmap].);
	      		// No effect
	        	//layerControl[whichmap].removeLayer(overlays["Counties"]);

	        	//geojsonLayer.remove();

	        	// Might work a little

	        	//alert("Remove the prior topo layer")
	        	//map.removeLayer(geojsonLayer); // Remove the prior topo layer
	       	}
	    }
      	// layerControl wasn't yet available in loading sequence.
      	// Could require localsite/js/map.js load first, but top maps might not always be loaded.
      	// Or only declare layerControl object if not yet declared.

      	if (layerControl[whichmap] == undefined) {
	    	layerControl[whichmap] = L.control.layers(basemaps1, overlays).addTo(map); // Push multple layers
	    	//basemaps1["Satellite"].addTo(map);
	    	basemaps1["Streets"].addTo(map);
	    } else {
	    	// Error: Cannot read property 'on' of undefined
	    	//layerControl[whichmap].addOverlay(dp.group, dp.dataTitle); // Appends to existing layers
	    }


      	if(layerControl === false) {
      		
      		//layerControl = L.control.layers(baseLayers, overlays).addTo(map);
      	}
      }

      // Remove - clear the markers from the map for the layer
       //if (map.hasLayer(overlays1[dp.dataTitle])){
       //   overlays1[dp.dataTitle].remove();
       //}
       //if (map.hasLayer(overlays["Counties"])){
       //	  alert("found layer")
       		//no effect
          	//overlays["Counties"].remove();
       //}

      // Make a layer active. 
      // Seems to prevent error
      //geojsonLayer.addTo(map);
      
      

      // To add additional layers:
      //layerControl.addOverlay(dp.group, dp.name); // Appends to existing layers


        /* Rollover effect */
        function highlightFeature(e){
          var layer = e.target;
          layer.setStyle({
            weight: 3,
            color: '#665',
            dashArray: '',
            fillOpacity: .7})
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
            }
          // Send text to side box
          info.update(layer.feature.properties);
        }
   
        function resetHighlight(e){
          geojsonLayer.resetStyle(e.target);
          info.update();
        }

        function mapFeatureClick(e) {
        	param = loadParams(location.search,location.hash); // param is declared in localsite.js
            var layer = e.target;
            //map.fitBounds(e.target.getBounds()); // Zoom to boundary area clicked
            var fips = "US" + layer.feature.properties.STATEFP + layer.feature.properties.COUNTYFP;
            //var fipsString = fips;
            if (param.geo && param.geo.split(",").includes(fips)) {
        		// Remove clicked fips from array, then convert back to string
        		param.geo = jQuery.grep(param.geo.split(","), function(value) {return value != fips;}).toString();
        		//fipsString = param.geo;
        	} else if (param.geo && param.geo.split(",").length > 0) {
        		param.geo = param.geo + "," + fips;
        	} else {
        		param.geo = fips;
        	}
            goHash({'geo':param.geo,'regiontitle':''});
        }

        function onEachFeature(feature, layer){
          layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight, 
                click: mapFeatureClick
          })
        }


        var info = L.control();

        // TEMP - reactivate
        info.onAdd = function(map) {
        	//alert("attempt")
        	if ($(".info.leaflet-control").length) {
        		$(".info.leaflet-control").remove(); // Prevent adding multiple times
        	}
        	//if (!$(".info.leaflet-control").length) { // Prevent adding multiple times
        	//	alert("does not exist")
        		this._div = L.DomUtil.create('div', 'info');
        	//} else {
        		//$(".info.leaflet-control").text("bug");

        		//this._div = $(".info.leaflet-control"); // Does not work
        	//}
        	this.update();
            return this._div;
        }

        info.update = function(props){
            if (props) {
              $(".info.leaflet-control").show();
            } else {
              $(".info.leaflet-control").hide();
            }
            // National
            //this._div.innerHTML = "<h4>Zip code</h4>" + (props ? props.zip + '</br>' + props.name + ' ' + props.state + '</br>' : "Hover over map")
            
            this._div.innerHTML = "" 
            + (props ? "<b>" + props.NAME + " County</b><br>" : "Hover over map") 
            + (props ? "FIPS 13" + props.COUNTYFP : "")
            

            // To fix if using state - id is not defined
            // Also, other state files may need to have primary node renamed to "data"
            //this._div.innerHTML = "<h4>Zip code</h4>" + (1==1 ? id + '</br>' : "Hover over map")
        }
        if (map) {
        	info.addTo(map);
    	}
     }
  }
}

// This could be reactivated to merge another dataset to map popups
function mergeInDetailData(topodata,detail_data) {
  var data_by_id = d3.nest() // where id is a zipcode or countyID
    .key(function(d){return d.zcta;})
    .entries(detail_data);

  topodata.features.forEach(function(d) {
        // d.properties.zip becomes d.properties.COUNTYFP
        var topoID = data_by_id.find(x=>x.key === d.properties.COUNTYFP.replace(/^0+/, ''));
        if(topoID) {
            columns.forEach(function(c){
                d[c] = parseFloat(topoID.values[0][c]);
            });
            cluster_data.push(d); // Topo shape data now has census attributes added, including zcta
        }
  });
  return cluster_data;
}

function styleShape(feature) {

	let hash = getHash(); // To do: pass in as parameter

	//console.log("feature ", feature)

    // Called for each topojson row
    // console.log("feature.properties.COUNTYFP: " + feature.properties.COUNTYFP);
    var fillColor = 'rgb(51, 136, 255)'; // 
    // For hover '#665';
    
    // REGION COLORS: See community/start/map/counties.html for colored region sample.
    /*
    dp.data.forEach(function(datarow) { // For each county row from the region lookup table
      if (datarow.county_num == feature.properties.COUNTYFP) {
        fillColor = color(datarow.io_region);
      }
    })
	*/
	let fillOpacity = .15;
	if (hash.geo && hash.geo.includes("US" + feature.properties.STATEFP + feature.properties.COUNTYFP)) {
    	fillColor = 'purple';
    	fillOpacity = .4;
	}
    return {
        weight: 3,
        opacity: .7,
        color: fillColor, // '#ccc', // 'white'
        //dashArray: '3',
        fillOpacity: fillOpacity,
        fillColor: fillColor
    };
    
}
</script>



<script>
// DELETE THIS FUNCTION
function loadIOWidgets(param) {

	/*
    const config = useeio.urlConfig();
    const modelID = config.get().model || 'GAUSEEIO';

    const model = useeio.model({
        endpoint: '/io/build/api',
        //endpoint: 'https://useeiowidgets.imfast.io/api',
        model: modelID,
        asJsonFiles: true,
    });



    // LEFT - INPUT
 	//if (param["view"] == "io") {

	    const heatmap_input = useeio.industryList({
	        model: model,
	        selector: '#impact-heatmap-input',
	        scope: 'input'
	    });
	    const paginator_input = useeio.paginator({
	        model: model,
	        selector: '#paginator-input',
	        scope: 'input',
	    });
	    config.join(heatmap_input);
	    config.join(paginator_input);

	    $("#io-input").show();
	//}

	// CENTER - MAIN SECTORS
    const heatmap = useeio.industryList({
        model: model,
        selector: '#impact-heatmap-main',
        scope: 'main'
    });
    const paginator = useeio.paginator({
        model: model,
        selector: '#paginator-main',
        scope: 'main' //  When scope is blank, the main pagination drive others
    });
    config.join(heatmap);
    config.join(paginator);

   
    // RIGHT - OUTPUT
    //if (param["view"] == "io") {
	 	const heatmap_output = useeio.industryList({
	        model: model,
	        selector: '#impact-heatmap-output',
	        scope: 'output'
	    });
	    const paginator_output = useeio.paginator({
	        model: model,
	        selector: '#paginator-output',
	        scope: 'output'
	    });
	    config.join(heatmap_output);
	    config.join(paginator_output);
	    
	    $("#io-output").show();
	//}
	*/




	/* Seems that these are no longer overwriting the existing hash values.

	But an error occurs of no parameters in URL
	 */

	/*
	config.updateIfAbsent({
	  count: 20,
	  view: "mosaic"
	});
	config.updateIfAbsent({
	  count: 20,
	  scopes: {
	    'input': {
	      count: 5,
	     },
	  },
	});
	*/


	// http://localhost:8887/localsite/info/#go=manufacturing&catsize=6

}

// INIT
refreshWidgets();
if (!param.geo) { // Others gets called by refreshWidgets on init.
	renderMapShapes("geomap", param);
}

</script>


</body>
</html>